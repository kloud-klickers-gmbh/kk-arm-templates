{
    "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "baseTime": {
            "type": "string",
            "defaultValue": "[utcNow()]"
        },
        "prefix": {
            "type": "string"
        },
        "location": {
            "allowedValues": [
                "westeurope",
                "germanywestcentral"
            ],
            "type": "String"
        },
        "tags": {
            "type": "Object"
        },
        "vnetAddressPrefix": {
            "type": "String"
        },
        "LanAddressPrefix": {
            "type": "String"
        },
        "WanAddressPrefix": {
            "type": "String"
        },
        "DmzAddressPrefix": {
            "type": "String"
        },
        "JumpHostAdminUsername": {
            "type": "String"
        },
        "JumpHostAdminPassword": {
            "type": "SecureString"
        },
        "JumpHostImageSku": {
            "defaultValue": "win11-23h2-pro",
            "type": "String"
        },
        "JumpHostPublicIpDnsName": {
            "type": "String"
        },
        "JumpHostRDPRemoteIP": {
            "type": "string"
        },
        "JumpHostVmLicenseType": {
            "type": "string",
            "defaultValue": "none",
            "allowedValues": [
                "Windows_Client",
                "Windows_Server",
                "none"
            ]
        },
        "JumpHostVmSize": {
            "type": "string",
            "defaultValue": "Standard_B2S"
        }
    },
    "variables": {
        "backupRgName": "[concat(parameters('prefix'),'-backup-rg')]",
        "vaultName": "[concat(parameters('prefix'),'-backup-lrs')]",
        "vaultName_grs": "[concat(parameters('prefix'),'-backup-grs')]",
        "PolicyName_daily_filestore": "[concat(parameters('prefix'),'-daily-backup-Filestore')]",
        "PolicyName_daily_profiles": "[concat(parameters('prefix'),'-daily-backup-Profiles')]",
        "PolicyName_daily_vm": "[concat(parameters('prefix'),'-daily-backup-VM')]",
        "PolicyName_daily_wvd": "[concat(parameters('prefix'),'-daily-backup-AVD')]",
        "PolicyRetentionDays_filestore": 60,
        "PolicyRetentionDays_profiles": 30,
        "PolicyRetentionDays_vm": 30,
        "PolicyRetentionDays_wvd": 7,
        "vaultStorageType": "LocallyRedundant",
        "vaultStorageType_grs": "GeoRedundant",
        "enableCRR": false,
        "BackupScheduleTime": "22:00",
        "JumpHostRgName": "[concat(parameters('prefix'),'-jumphost-rg')]",
        "jumphostName": "[concat(parameters('prefix'),'-jumphost')]",
        "JumpHostDeployPublicIp": true,
        "vnetRgName": "[concat(parameters('prefix'),'-vnet-rg')]",
        "vnetName": "[concat(parameters('prefix'),'-vnet')]",
        "SubnetDMZName": "[concat(parameters('prefix'),'-dmz-subnet')]",
        "SubnetLANName": "[concat(parameters('prefix'),'-lan-subnet')]",
        "SubnetWANName": "[concat(parameters('prefix'),'-wan-subnet')]",
        "NSGName": "[concat(parameters('prefix'),'-nsg')]",
        "maintenanceRgName": "[concat(parameters('prefix'),'-maintenance-rg')]",
        "maintenanceLocation": "[parameters('location')]",
        "maintenanceName": "[concat(parameters('prefix'),'-update-schedule')]",
        "maintenanceSchedule": {
            "startDateTime": "[dateTimeAdd(parameters('baseTime'), 'P1D', 'yyyy-MM-dd 22:00')]",
            "duration": "02:00",
            "timeZone": "W. Europe Standard Time",
            "expirationDateTime": null,
            "recurEvery": "1Week Thursday"
        },
        "maintenanceScope": "InGuestPatch",
        "ScheduleTimeZone": "W. Europe Standard Time",
        "SecurityPricing": [
            {
                "Name": "SqlServers",
                "PricingTier": "Free"
            },
            {
                "Name": "AppServices",
                "PricingTier": "Free"
            },
            {
                "Name": "SqlServerVirtualMachines",
                "PricingTier": "Free"
            },
            {
                "Name": "KubernetesService",
                "PricingTier": "Free"
            },
            {
                "Name": "ContainerRegistry",
                "PricingTier": "Free"
            },
            {
                "Name": "KeyVaults",
                "PricingTier": "Free"
            },
            {
                "Name": "Dns",
                "PricingTier": "Free"
            },
            {
                "Name": "Arm",
                "PricingTier": "Free"
            },
            {
                "Name": "OpenSourceRelationalDatabases",
                "PricingTier": "Free"
            },
            {
                "Name": "Containers",
                "PricingTier": "Free"
            }
        ]
    },
    "resources": [
        {
            "type": "Microsoft.Authorization/policyassignments",
            "apiVersion": "2020-09-01",
            "name": "[concat('Microsoft Cloud Security ', subscription().subscriptionId)]",
            "location": "[parameters('location')]",
            "properties": {
                "displayName": "KK Security Center",
                "enforcementMode": "Default",
                "policyDefinitionId": "/providers/Microsoft.Authorization/policySetDefinitions/1f3afdf9-d0c9-4c3d-847f-89da613e70a8"
            }
        },
        {
            "name": "VirtualMachines",
            "dependsOn": [
                "[concat('Microsoft Cloud Security ', subscription().subscriptionId)]"
            ],
            "type": "Microsoft.Security/pricings",
            "apiVersion": "2022-03-01",
            "properties": {
                "subPlan": "P1",
                "pricingTier": "Standard"
            }
        },
        {
            "name": "StorageAccounts",
            "dependsOn": [
                "[concat('Microsoft Cloud Security ', subscription().subscriptionId)]"
            ],
            "type": "Microsoft.Security/pricings",
            "apiVersion": "2022-03-01",
            "properties": {
                "subPlan": "PerTransaction",
                "pricingTier": "Standard"
            }
        },
        {
            "type": "Microsoft.Security/pricings",
            "copy": {
                "count": "[length(variables('SecurityPricing'))]",
                "name": "SecurityPricingLoop"
            },
            "apiVersion": "2018-06-01",
            "name": "[variables('SecurityPricing')[copyIndex('SecurityPricingLoop')].Name]",
            "properties": {
                "pricingTier": "[variables('SecurityPricing')[copyIndex('SecurityPricingLoop')].PricingTier]"
            }
        },
        {
            "type": "Microsoft.Security/autoProvisioningSettings",
            "apiVersion": "2017-08-01-preview",
            "name": "default",
            "properties": {
                "autoProvision": "Off"
            }
        },
        {
            "type": "Microsoft.Security/serverVulnerabilityAssessmentsSettings",
            "apiVersion": "2023-05-01",
            "name": "azureServersSetting",
            "kind": "AzureServersSetting",
            "properties": {
                "selectedProvider": "MdeTvm"
            }
        },
        {
            "type": "Microsoft.Security/settings",
            "apiVersion": "2022-05-01",
            "name": "WDATP",
            "kind": "DataExportSettings",
            "properties": {
                "enabled": true
            }
        },
        {
            "type": "Microsoft.Security/settings",
            "apiVersion": "2022-05-01",
            "name": "WDATP_UNIFIED_SOLUTION",
            "kind": "DataExportSettings",
            "properties": {
                "enabled": true
            }
        },
        {
            "type": "Microsoft.Resources/resourceGroups",
            "apiVersion": "2020-06-01",
            "name": "[variables('backupRgName')]",
            "location": "[parameters('Location')]",
            "properties": {}
        },
        {
            "type": "Microsoft.Resources/resourceGroups",
            "apiVersion": "2020-06-01",
            "name": "[variables('JumpHostRgName')]",
            "location": "[parameters('Location')]",
            "properties": {}
        },
        {
            "type": "Microsoft.Resources/resourceGroups",
            "apiVersion": "2020-06-01",
            "name": "[variables('maintenanceRgName')]",
            "location": "[variables('maintenanceLocation')]",
            "properties": {}
        },
        {
            "type": "Microsoft.Resources/resourceGroups",
            "apiVersion": "2020-06-01",
            "name": "[variables('vnetRgName')]",
            "location": "[parameters('Location')]",
            "properties": {}
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "Backup-Vault-LRS",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/resourceGroups', variables('backupRgName'))]"
            ],
            "properties": {
                "expressionEvaluationOptions": {
                    "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                    "vaultName": {
                        "value": "[variables('vaultName')]"
                    },
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "tags": {
                        "value": "[parameters('tags')]"
                    },
                    "enableCRR": {
                        "value": "[variables('enableCRR')]"
                    },
                    "vaultStorageType": {
                        "value": "[variables('vaultStorageType')]"
                    },
                    "PolicyName_daily_filestore": {
                        "value": "[variables('PolicyName_daily_filestore')]"
                    },
                    "PolicyName_daily_profiles": {
                        "value": "[variables('PolicyName_daily_profiles')]"
                    },
                    "PolicyName_daily_vm": {
                        "value": "[variables('PolicyName_daily_vm')]"
                    },
                    "PolicyName_daily_wvd": {
                        "value": "[variables('PolicyName_daily_wvd')]"
                    },
                    "PolicyRetentionDays_filestore": {
                        "value": "[variables('PolicyRetentionDays_filestore')]"
                    },
                    "PolicyRetentionDays_profiles": {
                        "value": "[variables('PolicyRetentionDays_profiles')]"
                    },
                    "PolicyRetentionDays_vm": {
                        "value": "[variables('PolicyRetentionDays_vm')]"
                    },
                    "PolicyRetentionDays_wvd": {
                        "value": "[variables('PolicyRetentionDays_wvd')]"
                    },
                    "BackupScheduleTime": {
                        "value": "[variables('BackupScheduleTime')]"
                    },
                    "ScheduleTimeZone": {
                        "value": "[variables('ScheduleTimeZone')]"
                    }
                },
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "vaultName": {
                            "type": "string"
                        },
                        "location": {
                            "type": "string"
                        },
                        "tags": {
                            "type": "object"
                        },
                        "enableCRR": {
                            "type": "bool"
                        },
                        "vaultStorageType": {
                            "type": "string"
                        },
                        "PolicyName_daily_filestore": {
                            "type": "string"
                        },
                        "PolicyRetentionDays_filestore": {
                            "type": "int"
                        },
                        "PolicyName_daily_profiles": {
                            "type": "string"
                        },
                        "PolicyRetentionDays_profiles": {
                            "type": "int"
                        },
                        "PolicyName_daily_vm": {
                            "type": "string"
                        },
                        "PolicyRetentionDays_vm": {
                            "type": "int"
                        },
                        "PolicyName_daily_wvd": {
                            "type": "string"
                        },
                        "PolicyRetentionDays_wvd": {
                            "type": "int"
                        },
                        "BackupScheduleTime": {
                            "type": "string"
                        },
                        "ScheduleTimeZone": {
                            "type": "string"
                        }
                    },
                    "variables": {
                        "skuName": "RS0",
                        "skuTier": "Standard"
                    },
                    "resources": [
                        {
                            "type": "Microsoft.RecoveryServices/vaults",
                            "apiVersion": "2020-02-02",
                            "name": "[parameters('vaultName')]",
                            "location": "[parameters('location')]",
                            "tags": "[parameters('tags')]",
                            "sku": {
                                "name": "[variables('skuName')]",
                                "tier": "[variables('skuTier')]"
                            },
                            "properties": {}
                        },
                        {
                            "type": "Microsoft.RecoveryServices/vaults/backupstorageconfig",
                            "apiVersion": "2021-07-01",
                            "name": "[concat(parameters('vaultName'), '/vaultstorageconfig')]",
                            "dependsOn": [
                                "[resourceId('Microsoft.RecoveryServices/vaults/', parameters('vaultName'))]"
                            ],
                            "properties": {
                                "StorageModelType": "[parameters('vaultStorageType')]",
                                "CrossRegionRestoreFlag": "[parameters('enableCRR')]"
                            }
                        },
                        {
                            "type": "Microsoft.RecoveryServices/vaults/backupPolicies",
                            "apiVersion": "2021-04-01",
                            "name": "[concat(parameters('vaultName'), '/', parameters('PolicyName_daily_filestore'))]",
                            "dependsOn": [
                                "[resourceId('Microsoft.RecoveryServices/vaults', parameters('vaultName'))]"
                            ],
                            "properties": {
                                "backupManagementType": "AzureStorage",
                                "workLoadType": "AzureFileShare",
                                "schedulePolicy": {
                                    "schedulePolicyType": "SimpleSchedulePolicy",
                                    "scheduleRunFrequency": "Daily",
                                    "scheduleRunTimes": [
                                        "[parameters('BackupScheduleTime')]"
                                    ]
                                },
                                "retentionPolicy": {
                                    "retentionPolicyType": "LongTermRetentionPolicy",
                                    "dailySchedule": {
                                        "retentionTimes": [
                                            "[parameters('BackupScheduleTime')]"
                                        ],
                                        "retentionDuration": {
                                            "count": "[parameters('PolicyRetentionDays_filestore')]",
                                            "durationType": "Days"
                                        }
                                    },
                                    "weeklySchedule": {
                                        "daysOfTheWeek": [
                                            "Sunday"
                                        ],
                                        "retentionTimes": [
                                            "[parameters('BackupScheduleTime')]"
                                        ],
                                        "retentionDuration": {
                                            "count": 52,
                                            "durationType": "Weeks"
                                        }
                                    }
                                },
                                "timeZone": "[parameters('ScheduleTimeZone')]"
                            }
                        },
                        {
                            "type": "Microsoft.RecoveryServices/vaults/backupPolicies",
                            "apiVersion": "2021-04-01",
                            "name": "[concat(parameters('vaultName'), '/', parameters('PolicyName_daily_profiles'))]",
                            "dependsOn": [
                                "[resourceId('Microsoft.RecoveryServices/vaults', parameters('vaultName'))]"
                            ],
                            "properties": {
                                "backupManagementType": "AzureStorage",
                                "workLoadType": "AzureFileShare",
                                "schedulePolicy": {
                                    "schedulePolicyType": "SimpleSchedulePolicy",
                                    "scheduleRunFrequency": "Daily",
                                    "scheduleRunTimes": [
                                        "[parameters('BackupScheduleTime')]"
                                    ]
                                },
                                "retentionPolicy": {
                                    "retentionPolicyType": "LongTermRetentionPolicy",
                                    "dailySchedule": {
                                        "retentionTimes": [
                                            "[parameters('BackupScheduleTime')]"
                                        ],
                                        "retentionDuration": {
                                            "count": "[parameters('PolicyRetentionDays_profiles')]",
                                            "durationType": "Days"
                                        }
                                    },
                                    "weeklySchedule": {
                                        "daysOfTheWeek": [
                                            "Sunday"
                                        ],
                                        "retentionTimes": [
                                            "[parameters('BackupScheduleTime')]"
                                        ],
                                        "retentionDuration": {
                                            "count": 52,
                                            "durationType": "Weeks"
                                        }
                                    }
                                },
                                "timeZone": "[parameters('ScheduleTimeZone')]"
                            }
                        },
                        {
                            "type": "Microsoft.RecoveryServices/vaults/backupPolicies",
                            "apiVersion": "2021-04-01",
                            "name": "[concat(parameters('vaultName'), '/', parameters('PolicyName_daily_vm'))]",
                            "dependsOn": [
                                "[resourceId('Microsoft.RecoveryServices/vaults', parameters('vaultName'))]"
                            ],
                            "properties": {
                                "backupManagementType": "AzureIaasVM",
                                "schedulePolicy": {
                                    "schedulePolicyType": "SimpleSchedulePolicy",
                                    "scheduleRunFrequency": "Daily",
                                    "scheduleRunTimes": [
                                        "[parameters('BackupScheduleTime')]"
                                    ]
                                },
                                "retentionPolicy": {
                                    "retentionPolicyType": "LongTermRetentionPolicy",
                                    "dailySchedule": {
                                        "retentionTimes": [
                                            "[parameters('BackupScheduleTime')]"
                                        ],
                                        "retentionDuration": {
                                            "count": "[parameters('PolicyRetentionDays_vm')]",
                                            "durationType": "Days"
                                        }
                                    },
                                    "weeklySchedule": {
                                        "daysOfTheWeek": [
                                            "Sunday"
                                        ],
                                        "retentionTimes": [
                                            "[parameters('BackupScheduleTime')]"
                                        ],
                                        "retentionDuration": {
                                            "count": 52,
                                            "durationType": "Weeks"
                                        }
                                    }
                                },
                                "instantRPDetails": {
                                    "azureBackupRGNamePrefix": "[concat(parameters('vaultName'),'RestorePoints-')]",
                                    "azureBackupRGNameSuffix": "[concat('-',parameters('location'))]"
                                },
                                "instantRpRetentionRangeInDays": 2,
                                "timeZone": "[parameters('ScheduleTimeZone')]"
                            }
                        },
                        {
                            "type": "Microsoft.RecoveryServices/vaults/backupPolicies",
                            "apiVersion": "2021-04-01",
                            "name": "[concat(parameters('vaultName'), '/', parameters('PolicyName_daily_wvd'))]",
                            "dependsOn": [
                                "[resourceId('Microsoft.RecoveryServices/vaults', parameters('vaultName'))]"
                            ],
                            "properties": {
                                "backupManagementType": "AzureIaasVM",
                                "schedulePolicy": {
                                    "schedulePolicyType": "SimpleSchedulePolicy",
                                    "scheduleRunFrequency": "Daily",
                                    "scheduleRunTimes": [
                                        "[parameters('BackupScheduleTime')]"
                                    ]
                                },
                                "retentionPolicy": {
                                    "retentionPolicyType": "LongTermRetentionPolicy",
                                    "dailySchedule": {
                                        "retentionTimes": [
                                            "[parameters('BackupScheduleTime')]"
                                        ],
                                        "retentionDuration": {
                                            "count": "[parameters('PolicyRetentionDays_wvd')]",
                                            "durationType": "Days"
                                        }
                                    },
                                    "weeklySchedule": {
                                        "daysOfTheWeek": [
                                            "Sunday"
                                        ],
                                        "retentionTimes": [
                                            "[parameters('BackupScheduleTime')]"
                                        ],
                                        "retentionDuration": {
                                            "count": 52,
                                            "durationType": "Weeks"
                                        }
                                    }
                                },
                                "instantRPDetails": {
                                    "azureBackupRGNamePrefix": "[concat(parameters('vaultName'),'RestorePoints-')]",
                                    "azureBackupRGNameSuffix": "[concat('-',parameters('location'))]"
                                },
                                "instantRpRetentionRangeInDays": 2,
                                "timeZone": "[parameters('ScheduleTimeZone')]"
                            }
                        }
                    ],
                    "outputs": {}
                }
            },
            "resourceGroup": "[variables('backupRgName')]"
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "Backup-Vault-GRS",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/resourceGroups', variables('backupRgName'))]"
            ],
            "properties": {
                "expressionEvaluationOptions": {
                    "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                    "vaultName": {
                        "value": "[variables('vaultName_grs')]"
                    },
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "tags": {
                        "value": "[parameters('tags')]"
                    },
                    "enableCRR": {
                        "value": "[variables('enableCRR')]"
                    },
                    "vaultStorageType": {
                        "value": "[variables('vaultStorageType_grs')]"
                    },
                    "PolicyName_daily_filestore": {
                        "value": "[variables('PolicyName_daily_filestore')]"
                    },
                    "PolicyName_daily_profiles": {
                        "value": "[variables('PolicyName_daily_profiles')]"
                    },
                    "PolicyName_daily_vm": {
                        "value": "[variables('PolicyName_daily_vm')]"
                    },
                    "PolicyName_daily_wvd": {
                        "value": "[variables('PolicyName_daily_wvd')]"
                    },
                    "PolicyRetentionDays_filestore": {
                        "value": "[variables('PolicyRetentionDays_filestore')]"
                    },
                    "PolicyRetentionDays_profiles": {
                        "value": "[variables('PolicyRetentionDays_profiles')]"
                    },
                    "PolicyRetentionDays_vm": {
                        "value": "[variables('PolicyRetentionDays_vm')]"
                    },
                    "PolicyRetentionDays_wvd": {
                        "value": "[variables('PolicyRetentionDays_wvd')]"
                    },
                    "BackupScheduleTime": {
                        "value": "[variables('BackupScheduleTime')]"
                    },
                    "ScheduleTimeZone": {
                        "value": "[variables('ScheduleTimeZone')]"
                    }
                },
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "vaultName": {
                            "type": "string"
                        },
                        "location": {
                            "type": "string"
                        },
                        "tags": {
                            "type": "object"
                        },
                        "enableCRR": {
                            "type": "bool"
                        },
                        "vaultStorageType": {
                            "type": "string"
                        },
                        "PolicyName_daily_filestore": {
                            "type": "string"
                        },
                        "PolicyRetentionDays_filestore": {
                            "type": "int"
                        },
                        "PolicyName_daily_profiles": {
                            "type": "string"
                        },
                        "PolicyRetentionDays_profiles": {
                            "type": "int"
                        },
                        "PolicyName_daily_vm": {
                            "type": "string"
                        },
                        "PolicyRetentionDays_vm": {
                            "type": "int"
                        },
                        "PolicyName_daily_wvd": {
                            "type": "string"
                        },
                        "PolicyRetentionDays_wvd": {
                            "type": "int"
                        },
                        "BackupScheduleTime": {
                            "type": "string"
                        },
                        "ScheduleTimeZone": {
                            "type": "string"
                        }
                    },
                    "variables": {
                        "skuName": "RS0",
                        "skuTier": "Standard"
                    },
                    "resources": [
                        {
                            "type": "Microsoft.RecoveryServices/vaults",
                            "apiVersion": "2020-02-02",
                            "name": "[parameters('vaultName')]",
                            "location": "[parameters('location')]",
                            "tags": "[parameters('tags')]",
                            "sku": {
                                "name": "[variables('skuName')]",
                                "tier": "[variables('skuTier')]"
                            },
                            "properties": {}
                        },
                        {
                            "type": "Microsoft.RecoveryServices/vaults/backupstorageconfig",
                            "apiVersion": "2021-07-01",
                            "name": "[concat(parameters('vaultName'), '/vaultstorageconfig')]",
                            "dependsOn": [
                                "[resourceId('Microsoft.RecoveryServices/vaults/', parameters('vaultName'))]"
                            ],
                            "properties": {
                                "StorageModelType": "[parameters('vaultStorageType')]",
                                "CrossRegionRestoreFlag": "[parameters('enableCRR')]"
                            }
                        },
                        {
                            "type": "Microsoft.RecoveryServices/vaults/backupPolicies",
                            "apiVersion": "2021-04-01",
                            "name": "[concat(parameters('vaultName'), '/', parameters('PolicyName_daily_filestore'))]",
                            "dependsOn": [
                                "[resourceId('Microsoft.RecoveryServices/vaults', parameters('vaultName'))]"
                            ],
                            "properties": {
                                "backupManagementType": "AzureStorage",
                                "workLoadType": "AzureFileShare",
                                "schedulePolicy": {
                                    "schedulePolicyType": "SimpleSchedulePolicy",
                                    "scheduleRunFrequency": "Daily",
                                    "scheduleRunTimes": [
                                        "[parameters('BackupScheduleTime')]"
                                    ]
                                },
                                "retentionPolicy": {
                                    "retentionPolicyType": "LongTermRetentionPolicy",
                                    "dailySchedule": {
                                        "retentionTimes": [
                                            "[parameters('BackupScheduleTime')]"
                                        ],
                                        "retentionDuration": {
                                            "count": "[parameters('PolicyRetentionDays_filestore')]",
                                            "durationType": "Days"
                                        }
                                    },
                                    "weeklySchedule": {
                                        "daysOfTheWeek": [
                                            "Sunday"
                                        ],
                                        "retentionTimes": [
                                            "[parameters('BackupScheduleTime')]"
                                        ],
                                        "retentionDuration": {
                                            "count": 52,
                                            "durationType": "Weeks"
                                        }
                                    }
                                },
                                "timeZone": "[parameters('ScheduleTimeZone')]"
                            }
                        },
                        {
                            "type": "Microsoft.RecoveryServices/vaults/backupPolicies",
                            "apiVersion": "2021-04-01",
                            "name": "[concat(parameters('vaultName'), '/', parameters('PolicyName_daily_profiles'))]",
                            "dependsOn": [
                                "[resourceId('Microsoft.RecoveryServices/vaults', parameters('vaultName'))]"
                            ],
                            "properties": {
                                "backupManagementType": "AzureStorage",
                                "workLoadType": "AzureFileShare",
                                "schedulePolicy": {
                                    "schedulePolicyType": "SimpleSchedulePolicy",
                                    "scheduleRunFrequency": "Daily",
                                    "scheduleRunTimes": [
                                        "[parameters('BackupScheduleTime')]"
                                    ]
                                },
                                "retentionPolicy": {
                                    "retentionPolicyType": "LongTermRetentionPolicy",
                                    "dailySchedule": {
                                        "retentionTimes": [
                                            "[parameters('BackupScheduleTime')]"
                                        ],
                                        "retentionDuration": {
                                            "count": "[parameters('PolicyRetentionDays_profiles')]",
                                            "durationType": "Days"
                                        }
                                    },
                                    "weeklySchedule": {
                                        "daysOfTheWeek": [
                                            "Sunday"
                                        ],
                                        "retentionTimes": [
                                            "[parameters('BackupScheduleTime')]"
                                        ],
                                        "retentionDuration": {
                                            "count": 52,
                                            "durationType": "Weeks"
                                        }
                                    }
                                },
                                "timeZone": "[parameters('ScheduleTimeZone')]"
                            }
                        },
                        {
                            "type": "Microsoft.RecoveryServices/vaults/backupPolicies",
                            "apiVersion": "2021-04-01",
                            "name": "[concat(parameters('vaultName'), '/', parameters('PolicyName_daily_vm'))]",
                            "dependsOn": [
                                "[resourceId('Microsoft.RecoveryServices/vaults', parameters('vaultName'))]"
                            ],
                            "properties": {
                                "backupManagementType": "AzureIaasVM",
                                "schedulePolicy": {
                                    "schedulePolicyType": "SimpleSchedulePolicy",
                                    "scheduleRunFrequency": "Daily",
                                    "scheduleRunTimes": [
                                        "[parameters('BackupScheduleTime')]"
                                    ]
                                },
                                "retentionPolicy": {
                                    "retentionPolicyType": "LongTermRetentionPolicy",
                                    "dailySchedule": {
                                        "retentionTimes": [
                                            "[parameters('BackupScheduleTime')]"
                                        ],
                                        "retentionDuration": {
                                            "count": "[parameters('PolicyRetentionDays_vm')]",
                                            "durationType": "Days"
                                        }
                                    },
                                    "weeklySchedule": {
                                        "daysOfTheWeek": [
                                            "Sunday"
                                        ],
                                        "retentionTimes": [
                                            "[parameters('BackupScheduleTime')]"
                                        ],
                                        "retentionDuration": {
                                            "count": 52,
                                            "durationType": "Weeks"
                                        }
                                    }
                                },
                                "instantRPDetails": {
                                    "azureBackupRGNamePrefix": "[concat(parameters('vaultName'),'RestorePoints-')]",
                                    "azureBackupRGNameSuffix": "[concat('-',parameters('location'))]"
                                },
                                "instantRpRetentionRangeInDays": 2,
                                "timeZone": "[parameters('ScheduleTimeZone')]"
                            }
                        },
                        {
                            "type": "Microsoft.RecoveryServices/vaults/backupPolicies",
                            "apiVersion": "2021-04-01",
                            "name": "[concat(parameters('vaultName'), '/', parameters('PolicyName_daily_wvd'))]",
                            "dependsOn": [
                                "[resourceId('Microsoft.RecoveryServices/vaults', parameters('vaultName'))]"
                            ],
                            "properties": {
                                "backupManagementType": "AzureIaasVM",
                                "schedulePolicy": {
                                    "schedulePolicyType": "SimpleSchedulePolicy",
                                    "scheduleRunFrequency": "Daily",
                                    "scheduleRunTimes": [
                                        "[parameters('BackupScheduleTime')]"
                                    ]
                                },
                                "retentionPolicy": {
                                    "retentionPolicyType": "LongTermRetentionPolicy",
                                    "dailySchedule": {
                                        "retentionTimes": [
                                            "[parameters('BackupScheduleTime')]"
                                        ],
                                        "retentionDuration": {
                                            "count": "[parameters('PolicyRetentionDays_wvd')]",
                                            "durationType": "Days"
                                        }
                                    },
                                    "weeklySchedule": {
                                        "daysOfTheWeek": [
                                            "Sunday"
                                        ],
                                        "retentionTimes": [
                                            "[parameters('BackupScheduleTime')]"
                                        ],
                                        "retentionDuration": {
                                            "count": 52,
                                            "durationType": "Weeks"
                                        }
                                    }
                                },
                                "instantRPDetails": {
                                    "azureBackupRGNamePrefix": "[concat(parameters('vaultName'),'RestorePoints-')]",
                                    "azureBackupRGNameSuffix": "[concat('-',parameters('location'))]"
                                },
                                "instantRpRetentionRangeInDays": 2,
                                "timeZone": "[parameters('ScheduleTimeZone')]"
                            }
                        }
                    ],
                    "outputs": {}
                }
            },
            "resourceGroup": "[variables('backupRgName')]"
        },
        {
            "type": "Microsoft.Authorization/policyassignments",
            "apiVersion": "2023-04-01",
            "name": "[concat('Update Policy Windows ', subscription().subscriptionId)]",
            "location": "[variables('maintenanceLocation')]",
            "identity": {
                "type": "SystemAssigned"
            },
            "properties": {
                "displayName": "KK Periodic Update Policy (Windows)",
                "enforcementMode": "Default",
                "policyDefinitionId": "/providers/microsoft.authorization/policydefinitions/59efceea-0c96-497e-a4a1-4eb2290dac15",
                "nonComplianceMessages": [
                    {
                        "message": "The VM is not compliant with the periodic update policy (Windows)."
                    }
                ],
                "scope": "[concat('/subscriptions/', subscription().subscriptionId)]",
                "parameters": {
                    "osType": {
                        "value": "Windows"
                    },
                    "assessmentMode": {
                        "value": "AutomaticByPlatform"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Authorization/policyassignments",
            "apiVersion": "2023-04-01",
            "name": "[concat('Update Policy Linux ', subscription().subscriptionId)]",
            "location": "[variables('maintenanceLocation')]",
            "identity": {
                "type": "SystemAssigned"
            },
            "properties": {
                "displayName": "KK Periodic Update Policy (Linux)",
                "enforcementMode": "Default",
                "policyDefinitionId": "/providers/microsoft.authorization/policydefinitions/59efceea-0c96-497e-a4a1-4eb2290dac15",
                "nonComplianceMessages": [
                    {
                        "message": "The VM is not compliant with the periodic update policy (Linux)."
                    }
                ],
                "scope": "[concat('/subscriptions/', subscription().subscriptionId)]",
                "parameters": {
                    "osType": {
                        "value": "Linux"
                    },
                    "assessmentMode": {
                        "value": "AutomaticByPlatform"
                    }
                }
            }
        },
        {
            "type": "Microsoft.PolicyInsights/remediations",
            "apiVersion": "2021-10-01",
            "name": "[concat('Update Policy Windows Remediation ', subscription().subscriptionId)]",
            "dependsOn": [
                "[concat('Update Policy Windows ', subscription().subscriptionId)]"
            ],
            "condition": false,
            "properties": {
                "policyAssignmentId": "[resourceId('Microsoft.Authorization/policyassignments', concat('Update Policy Windows ', subscription().subscriptionId))]",
                "resourceDiscoveryMode": "ReEvaluateCompliance"
            }
        },
        {
            "type": "Microsoft.PolicyInsights/remediations",
            "apiVersion": "2021-10-01",
            "name": "[concat('Update Policy Linux Remediation ', subscription().subscriptionId)]",
            "dependsOn": [
                "[concat('Update Policy Linux ', subscription().subscriptionId)]"
            ],
            "condition": false,
            "properties": {
                "policyAssignmentId": "[resourceId('Microsoft.Authorization/policyassignments', concat('Update Policy Linux ', subscription().subscriptionId))]",
                "resourceDiscoveryMode": "ReEvaluateCompliance"
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "Update-Automation-Deployment",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/resourceGroups', variables('maintenanceRgName'))]"
            ],
            "resourceGroup": "[variables('maintenanceRgName')]",
            "properties": {
                "mode": "Incremental",
                "parameters": {},
                "template": {
                    "$schema": "http://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "resources": [
                        {
                            "apiVersion": "2023-04-01",
                            "type": "Microsoft.Maintenance/maintenanceConfigurations",
                            "name": "[variables('maintenanceName')]",
                            "location": "[variables('maintenanceLocation')]",
                            "tags": {},
                            "properties": {
                                "maintenanceScope": "InGuestPatch",
                                "installPatches": {
                                    "linuxParameters": {
                                        "classificationsToInclude": [
                                            "Critical",
                                            "Security"
                                        ],
                                        "packageNameMasksToExclude": null,
                                        "packageNameMasksToInclude": null
                                    },
                                    "windowsParameters": {
                                        "classificationsToInclude": [
                                            "Critical",
                                            "Security",
                                            "Definition"
                                        ],
                                        "kbNumbersToExclude": null,
                                        "kbNumbersToInclude": null
                                    },
                                    "rebootSetting": "RebootIfRequired"
                                },
                                "extensionProperties": {
                                    "InGuestPatchMode": "User"
                                },
                                "maintenanceWindow": {
                                    "startDateTime": "[variables('maintenanceSchedule').startDateTime]",
                                    "duration": "[variables('maintenanceSchedule').duration]",
                                    "timeZone": "[variables('maintenanceSchedule').timeZone]",
                                    "expirationDateTime": "[variables('maintenanceSchedule').expirationDateTime]",
                                    "recurEvery": "[variables('maintenanceSchedule').recurEvery]"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.Resources/deployments",
                            "apiVersion": "2021-04-01",
                            "name": "Update-Automation-Assignments-Deployment",
                            "dependsOn": [
                                "[concat('Microsoft.Maintenance/maintenanceConfigurations/', variables('maintenanceName'))]"
                            ],
                            "properties": {
                                "mode": "Incremental",
                                "parameters": {},
                                "template": {
                                    "$schema": "http://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                    "contentVersion": "1.0.0.0",
                                    "resources": [
                                        {
                                            "apiVersion": "2023-04-01",
                                            "type": "Microsoft.Maintenance/configurationAssignments",
                                            "name": "[concat(variables('maintenanceName'), '-assignments')]",
                                            "location": "[variables('maintenanceLocation')]",
                                            "properties": {
                                                "maintenanceConfigurationId": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', variables('maintenanceRgName'), '/providers/Microsoft.Maintenance/maintenanceConfigurations/', variables('maintenanceName'))]",
                                                "filter": {
                                                    "resourceTypes": [
                                                        "microsoft.compute/virtualmachines"
                                                    ],
                                                    "resourceGroups": [],
                                                    "osTypes": [
                                                        "Linux",
                                                        "Windows"
                                                    ],
                                                    "locations": []
                                                }
                                            }
                                        }
                                    ]
                                }
                            }
                        }
                    ]
                }
            }
        },
        {
            "type": "Microsoft.Authorization/policyassignments",
            "apiVersion": "2023-04-01",
            "name": "[concat('Update Schedule Policy ', subscription().subscriptionId)]",
            "dependsOn": [
                "[concat('Microsoft.Maintenance/maintenanceConfigurations/', variables('maintenanceName'))]"
            ],
            "location": "[variables('maintenanceLocation')]",
            "identity": {
                "type": "SystemAssigned"
            },
            "properties": {
                "displayName": "KK Periodic Update Schedule Policy",
                "enforcementMode": "Default",
                "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/ba0df93e-e4ac-479a-aac2-134bbae39a1a",
                "scope": "[concat('/subscriptions/', subscription().subscriptionId)]",
                "parameters": {
                    "maintenanceConfigurationResourceId": {
                        "value": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', variables('maintenanceRgName'), '/providers/Microsoft.Maintenance/maintenanceConfigurations/', variables('maintenanceName'))]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "Jumphost-Deployment",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/resourceGroups', variables('JumpHostRgName'))]",
                "[concat('/subscriptions/',subscription().subscriptionId,'/resourceGroups/',variables('vnetRgName'),'/providers/Microsoft.Resources/deployments/VNet-Deployment')]"
            ],
            "resourceGroup": "[variables('JumpHostRgName')]",
            "properties": {
                "expressionEvaluationOptions": {
                    "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                    "JumpHostAdminPassword": {
                        "value": "[parameters('JumpHostAdminPassword')]"
                    },
                    "JumpHostAdminUsername": {
                        "value": "[parameters('JumpHostAdminUsername')]"
                    },
                    "JumpHostDeployPublicIp": {
                        "value": "[variables('JumpHostDeployPublicIp')]"
                    },
                    "JumpHostImageSku": {
                        "value": "[parameters('JumpHostImageSku')]"
                    },
                    "jumphostName": {
                        "value": "[variables('jumphostName')]"
                    },
                    "JumpHostPublicIpDnsName": {
                        "value": "[parameters('JumpHostPublicIpDnsName')]"
                    },
                    "JumpHostRDPRemoteIP": {
                        "value": "[parameters('JumpHostRDPRemoteIP')]"
                    },
                    "JumpHostVmSize": {
                        "value": "[parameters('JumpHostVmSize')]"
                    },
                    "JumpHostVmLicenseType": {
                        "value": "[parameters('JumpHostVmLicenseType')]"
                    },
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "subnetLANName": {
                        "value": "[variables('SubnetLANName')]"
                    },
                    "tags": {
                        "value": "[parameters('tags')]"
                    },
                    "vnetName": {
                        "value": "[variables('vnetName')]"
                    },
                    "vnetRGName": {
                        "value": "[variables('vnetRgName')]"
                    }
                },
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "jumphostName": {
                            "type": "string"
                        },
                        "JumpHostAdminUsername": {
                            "type": "string"
                        },
                        "JumpHostAdminPassword": {
                            "type": "securestring"
                        },
                        "tags": {
                            "type": "object"
                        },
                        "JumpHostDeployPublicIp": {
                            "type": "bool"
                        },
                        "JumpHostPublicIpDnsName": {
                            "type": "string"
                        },
                        "location": {
                            "type": "string"
                        },
                        "vnetRGName": {
                            "type": "string"
                        },
                        "vnetName": {
                            "type": "string"
                        },
                        "subnetLANName": {
                            "type": "string"
                        },
                        "JumpHostVmSize": {
                            "type": "string"
                        },
                        "JumpHostImageSku": {
                            "type": "string"
                        },
                        "JumpHostRDPRemoteIP": {
                            "type": "string"
                        },
                        "JumpHostVmLicenseType": {
                            "type": "string"
                        }
                    },
                    "variables": {
                        "JumpHostPublicIpAllocationMethod": "Static",
                        "JumpHostStorageAccountType": "StandardSSD_LRS",
                        "imagePublisher": "MicrosoftWindowsDesktop",
                        "imageOffer": "Windows-11",
                        "jumphost_pip_name": "[concat(parameters('jumphostName'),'-pip')]",
                        "jumphost_nsg_name": "[concat(parameters('jumphostName'),'-nsg')]",
                        "jumphost_nic_name": "[concat(parameters('jumphostName'),'-nic')]",
                        "subnetId": "[concat('/subscriptions/', subscription().subscriptionId , '/resourceGroups/' , parameters('vnetrgname'), '/providers/Microsoft.Network/virtualNetworks/', parameters('vnetname'), '/subnets/', parameters('subnetLANName'))]"
                    },
                    "resources": [
                        {
                            "name": "[variables('jumphost_nsg_name')]",
                            "type": "Microsoft.Network/networkSecurityGroups",
                            "apiVersion": "2020-11-01",
                            "tags": "[parameters('tags')]",
                            "location": "[parameters('location')]",
                            "properties": {
                                "securityRules": [
                                    {
                                        "name": "allow_rdp_inbound",
                                        "properties": {
                                            "description": "Allow RDP from Office and Azure",
                                            "protocol": "Tcp",
                                            "sourcePortRange": "*",
                                            "destinationPortRange": "3389",
                                            "sourceAddressPrefix": "[parameters('JumpHostRDPRemoteIP')]",
                                            "destinationAddressPrefix": "*",
                                            "access": "Allow",
                                            "priority": 100,
                                            "direction": "Inbound"
                                        }
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.Network/publicIPAddresses",
                            "apiVersion": "2020-11-01",
                            "condition": "[parameters('JumpHostdeployPublicIp')]",
                            "name": "[variables('jumphost_pip_name')]",
                            "location": "[parameters('location')]",
                            "tags": "[parameters('tags')]",
                            "sku": {
                                "name": "Basic",
                                "tier": "Regional"
                            },
                            "properties": {
                                "publicIPAddressVersion": "IPv4",
                                "publicIPAllocationMethod": "[variables('JumpHostpublicIpAllocationMethod')]",
                                "idleTimeoutInMinutes": 4,
                                "dnsSettings": {
                                    "domainNameLabel": "[parameters('JumpHostPublicIpDnsName')]"
                                },
                                "ipTags": []
                            }
                        },
                        {
                            "type": "Microsoft.Compute/virtualMachines",
                            "apiVersion": "2020-12-01",
                            "name": "[parameters('jumphostName')]",
                            "location": "[parameters('location')]",
                            "dependsOn": [
                                "[resourceId('Microsoft.Network/networkInterfaces', variables('jumphost_nic_name'))]"
                            ],
                            "tags": "[parameters('tags')]",
                            "properties": {
                                "hardwareProfile": {
                                    "vmSize": "[parameters('JumpHostvmSize')]"
                                },
                                "storageProfile": {
                                    "imageReference": {
                                        "publisher": "[variables('imagePublisher')]",
                                        "offer": "[variables('imageOffer')]",
                                        "sku": "[parameters('JumpHostimageSku')]",
                                        "version": "latest"
                                    },
                                    "osDisk": {
                                        "osType": "Windows",
                                        "name": "[concat(parameters('jumphostName'), '_OsDisk_1')]",
                                        "createOption": "FromImage",
                                        "caching": "ReadWrite",
                                        "managedDisk": {
                                            "storageAccountType": "[variables('JumpHoststorageAccountType')]"
                                        }
                                    },
                                    "dataDisks": []
                                },
                                "osProfile": {
                                    "computerName": "[parameters('jumphostName')]",
                                    "adminUsername": "[parameters('JumpHostadminUsername')]",
                                    "adminPassword": "[parameters('JumpHostadminPassword')]",
                                    "windowsConfiguration": {
                                        "provisionVMAgent": true,
                                        "enableAutomaticUpdates": true,
                                        "patchSettings": {
                                            "patchMode": "AutomaticByOS"
                                        }
                                    }
                                },
                                "networkProfile": {
                                    "networkInterfaces": [
                                        {
                                            "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('jumphost_nic_name'))]"
                                        }
                                    ]
                                },
                                "diagnosticsProfile": {
                                    "bootDiagnostics": {
                                        "enabled": false
                                    }
                                },
                                "licenseType": "[if(equals('none',parameters('JumpHostVmLicenseType')),null(),parameters('JumpHostVmLicenseType'))]"
                            }
                        },
                        {
                            "type": "Microsoft.Compute/virtualMachines/extensions",
                            "apiVersion": "2020-12-01",
                            "name": "[concat(parameters('jumphostName'), '/BGInfo')]",
                            "location": "[parameters('location')]",
                            "dependsOn": [
                                "[resourceId('Microsoft.Compute/virtualMachines', parameters('jumphostName'))]"
                            ],
                            "properties": {
                                "autoUpgradeMinorVersion": true,
                                "publisher": "Microsoft.Compute",
                                "type": "BGInfo",
                                "typeHandlerVersion": "2.1"
                            }
                        },
                        {
                            "type": "Microsoft.Compute/virtualMachines/extensions",
                            "name": "[concat(parameters('jumphostName'),'/AntiMalware')]",
                            "apiVersion": "2020-12-01",
                            "location": "[parameters('location')]",
                            "dependsOn": [
                                "[resourceId('Microsoft.Compute/virtualMachines', parameters('jumphostName'))]"
                            ],
                            "properties": {
                                "publisher": "Microsoft.Azure.Security",
                                "type": "IaaSAntimalware",
                                "typeHandlerVersion": "1.5",
                                "autoUpgradeMinorVersion": true,
                                "settings": {
                                    "AntimalwareEnabled": true,
                                    "Exclusions": {
                                        "Extensions": "",
                                        "Paths": "",
                                        "Processes": ""
                                    },
                                    "RealtimeProtectionEnabled": "true",
                                    "ScheduledScanSettings": {
                                        "isEnabled": "true",
                                        "scanType": "Quick",
                                        "day": "7",
                                        "time": "120"
                                    }
                                }
                            }
                        },
                        {
                            "type": "Microsoft.Network/networkInterfaces",
                            "apiVersion": "2020-11-01",
                            "name": "[variables('jumphost_nic_name')]",
                            "location": "[parameters('location')]",
                            "tags": "[parameters('tags')]",
                            "dependsOn": [
                                "[resourceId('Microsoft.Network/publicIPAddresses', variables('jumphost_pip_name'))]",
                                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('jumphost_nsg_name'))]"
                            ],
                            "properties": {
                                "ipConfigurations": [
                                    {
                                        "name": "ipconfig1",
                                        "properties": {
                                            "privateIPAllocationMethod": "Dynamic",
                                            "publicIPAddress": {
                                                "id": "[if(parameters('JumpHostdeployPublicIp'), resourceId('Microsoft.Network/publicIPAddresses', variables('jumphost_pip_name')),json('null'))]"
                                            },
                                            "subnet": {
                                                "id": "[variables('subnetId')]"
                                            }
                                        }
                                    }
                                ],
                                "networkSecurityGroup": {
                                    "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('jumphost_nsg_name'))]"
                                }
                            }
                        }
                    ],
                    "outputs": {
                        "JumpHostPublicIPAddress": {
                            "type": "string",
                            "condition": "[parameters('JumpHostdeployPublicIp')]",
                            "value": "[reference(concat(subscription().id,'/resourcegroups/',resourceGroup().name,'/providers/Microsoft.Network/publicIpAddresses/',parameters('jumphostName'),'-pip'),'2019-02-01','Full').properties.ipaddress]"
                        },
                        "JumpHostInternalIPAddress": {
                            "type": "string",
                            "value": "[reference(concat(subscription().id,'/resourcegroups/',resourceGroup().name,'/providers/Microsoft.Network/networkInterfaces/',parameters('jumphostName'),'-nic'),'2021-03-01','Full').properties.ipconfigurations[0].properties.privateipaddress]"
                        },
                        "JumpHostDNSName": {
                            "type": "string",
                            "condition": "[parameters('JumpHostdeployPublicIp')]",
                            "value": "[reference(concat(subscription().id,'/resourcegroups/',resourceGroup().name,'/providers/Microsoft.Network/publicIpAddresses/',parameters('jumphostName'),'-pip'),'2019-02-01','Full').properties.dnssettings.fqdn]"
                        }
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "VNet-Deployment",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/resourceGroups', variables('vnetRgName'))]"
            ],
            "properties": {
                "expressionEvaluationOptions": {
                    "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "vnetName": {
                        "value": "[variables('vnetName')]"
                    },
                    "nsgName": {
                        "value": "[variables('NSGName')]"
                    },
                    "SubnetDmzName": {
                        "value": "[variables('SubnetDMZName')]"
                    },
                    "SubnetLanName": {
                        "value": "[variables('SubnetLANName')]"
                    },
                    "SubnetWanName": {
                        "value": "[variables('SubnetWANName')]"
                    },
                    "vnetAddressPrefix": {
                        "value": "[parameters('vnetAddressPrefix')]"
                    },
                    "LanAddressPrefix": {
                        "value": "[parameters('LanAddressPrefix')]"
                    },
                    "WanAddressPrefix": {
                        "value": "[parameters('WanAddressPrefix')]"
                    },
                    "DmzAddressPrefix": {
                        "value": "[parameters('DmzAddressPrefix')]"
                    },
                    "tags": {
                        "value": "[parameters('tags')]"
                    },
                    "JumpHostRDPRemoteIP": {
                        "value": "[parameters('JumpHostRDPRemoteIP')]"
                    }
                },
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "vnetName": {
                            "type": "String"
                        },
                        "nsgName": {
                            "type": "String"
                        },
                        "location": {
                            "type": "String"
                        },
                        "tags": {
                            "type": "object"
                        },
                        "SubnetLanName": {
                            "type": "string"
                        },
                        "SubnetWanName": {
                            "type": "string"
                        },
                        "SubnetDmzName": {
                            "type": "string"
                        },
                        "vnetAddressPrefix": {
                            "type": "string"
                        },
                        "LanAddressPrefix": {
                            "type": "string"
                        },
                        "WanAddressPrefix": {
                            "type": "string"
                        },
                        "DmzAddressPrefix": {
                            "type": "string"
                        },
                        "JumpHostRDPRemoteIP": {
                            "type": "string"
                        }
                    },
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.Network/networkSecurityGroups",
                            "apiVersion": "2020-11-01",
                            "name": "[parameters('nsgName')]",
                            "location": "[parameters('location')]",
                            "tags": "[parameters('tags')]",
                            "properties": {
                                "securityRules": [
                                    {
                                        "name": "allow_rdp_inbound",
                                        "properties": {
                                            "description": "Allow RDP from Office and Azure",
                                            "protocol": "Tcp",
                                            "sourcePortRange": "*",
                                            "destinationPortRange": "3389",
                                            "sourceAddressPrefix": "[parameters('JumpHostRDPRemoteIP')]",
                                            "destinationAddressPrefix": "*",
                                            "access": "Allow",
                                            "priority": 100,
                                            "direction": "Inbound"
                                        }
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.Network/virtualNetworks",
                            "dependsOn": [
                                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsgName'))]"
                            ],
                            "apiVersion": "2020-11-01",
                            "name": "[parameters('vnetName')]",
                            "location": "[parameters('location')]",
                            "tags": "[parameters('tags')]",
                            "properties": {
                                "addressSpace": {
                                    "addressPrefixes": [
                                        "[parameters('vnetAddressPrefix')]"
                                    ]
                                },
                                "dhcpOptions": {
                                    "dnsServers": []
                                },
                                "subnets": [
                                    {
                                        "name": "[parameters('SubnetLanName')]",
                                        "properties": {
                                            "addressPrefix": "[parameters('LanAddressPrefix')]",
                                            "serviceEndpoints": [
                                                {
                                                    "service": "Microsoft.Storage"
                                                }
                                            ],
                                            "delegations": [],
                                            "privateEndpointNetworkPolicies": "Enabled",
                                            "privateLinkServiceNetworkPolicies": "Enabled",
                                            "networkSecurityGroup": {
                                                "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsgName'))]"
                                            }
                                        }
                                    },
                                    {
                                        "name": "[parameters('SubnetWanName')]",
                                        "properties": {
                                            "addressPrefix": "[parameters('WanAddressPrefix')]",
                                            "serviceEndpoints": [],
                                            "delegations": [],
                                            "privateEndpointNetworkPolicies": "Enabled",
                                            "privateLinkServiceNetworkPolicies": "Enabled"
                                        }
                                    },
                                    {
                                        "name": "[parameters('SubnetDmzName')]",
                                        "properties": {
                                            "addressPrefix": "[parameters('DmzAddressPrefix')]",
                                            "serviceEndpoints": [],
                                            "delegations": [],
                                            "privateEndpointNetworkPolicies": "Enabled",
                                            "privateLinkServiceNetworkPolicies": "Enabled"
                                        }
                                    }
                                ],
                                "virtualNetworkPeerings": [],
                                "enableDdosProtection": false
                            }
                        }
                    ],
                    "outputs": {}
                }
            },
            "resourceGroup": "[variables('vnetRgName')]"
        }
    ],
    "outputs": {
        "Output_JumpHostPublicIPAddress": {
            "type": "string",
            "condition": "[variables('JumpHostdeployPublicIp')]",
            "value": "[reference('Jumphost-Deployment').outputs.JumpHostPublicIPAddress.value]"
        },
        "Output_JumpHostInternalIPAddress": {
            "type": "string",
            "value": "[reference('Jumphost-Deployment').outputs.JumpHostInternalIPAddress.value]"
        },
        "Output_JumpHostDNSName": {
            "type": "string",
            "condition": "[variables('JumpHostdeployPublicIp')]",
            "value": "[reference('Jumphost-Deployment').outputs.JumpHostDNSName.value]"
        }
    }
}
